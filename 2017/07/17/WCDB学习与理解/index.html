<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="iOS Swift Objective-C"><title>WCDB学习与理解 | Hale's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.1.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">WCDB学习与理解</h1><a id="logo" href="/.">Hale's Blog</a><p class="description">stay hungry stay foolish</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">WCDB学习与理解</h1><div class="post-meta">Jul 17, 2017<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><a data-disqus-identifier="2017/07/17/WCDB学习与理解/" href="/2017/07/17/WCDB学习与理解/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>WCDB（WeChat DataBase）是微信官方的移动端数据库组件，它基于SQLCipher，是一个关系型数据库，支持iOS, macOS和Android。WCDB提供了三个基础类进行数据库操作：WCTDatabase、WCTTable、WCTTransaction。它们的接口都是线程安全的。WCDB几乎涵盖了常用的数据库操作，同时还开放了核心层接口，方便用户扩展一些未封装的复杂SQL操作。安全方面它继承了SQLCipher的加密方式，内建了Repair Kit用于修复损坏的数据库,通过内建宏的方式实现了<code>ORM（Object Relational Mapping)</code>，方便地实现了对象属性到数据表字段的映射,通过一种名为<code>WINQ</code>的规则对SQL进行了抽象，避免了冗长的SQL胶水代码，也防止了SQL注入。</p>
<h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><p>WCDB使用内置的宏来连接类、属性与表、字段。共有三类宏，分别对应数据库的字段、索引和约束。所有宏都定义在WCTCodingMacro.h中。WCDB的ORM会自动识别property的类型，并映射到适合的数据库类型。其与Objective-C类型对应关系为：</p>
<ul>
<li>整型<ul>
<li>NSDate（保存其时间戳）</li>
</ul>
</li>
<li>浮点数<ul>
<li>NSNumber</li>
</ul>
</li>
<li>字符串<ul>
<li>NSString、NSMutableString</li>
</ul>
</li>
<li>二进制<ul>
<li>NSData、NSMutableData</li>
<li>NSArray、NSMutableArray</li>
<li>NSDictionary、NSMutableDictionary</li>
<li>NSSet、NSMutableSet</li>
<li>NSValue</li>
<li>NSURL</li>
</ul>
</li>
</ul>
<p>关于ORM官方github文档给出了详细的中英文教程包括字段宏、索引宏、约束宏等在此不一一列举。</p>
<h2 id="WINQ"><a href="#WINQ" class="headerlink" title="WINQ"></a>WINQ</h2><p>WINQ避免了冗长复杂的SQL拼接操作，对SQL语句进行了抽象。抽象的思路还是从SQL语法规则出发，SQL的语法规则实则上是一种链式操作，可以理解为一些固定的keyword、object和expr的集合。所以WINQ的实现思路是将固定的keyword，封装为函数名，作为连接；将可以展开的token，封装为类，并在类内实现其不同的组合。这句话可能说的有点绕，通过下面的代码块可能比较好理解些。在下面的代码块中，把<code>SELECT</code>定义成了一个类<code>StatementSelect</code>,这个类有三个函数，函数名我们并不陌生，正是<code>where</code>、<code>limit</code>、<code>having</code>三个SQL关键字，同时函数的返回也是一个StatementSelect对象，这样我们就能实现一种链式操作。实现了上面提到的<code>连接</code>。另外我们可以发现三个函数还有一个共同点，它们的参数都是Expr类型，因为在实际的SQL语法规则中where、limit、having等操作都是接受表达式的，所以这里StatementSelect的类方法都是表达式。然后在Expr内部可以实现表达式的各种组合。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class StatementSelect : public Statement &#123;</span><br><span class="line">public:</span><br><span class="line">    //...</span><br><span class="line">    StatementSelect &amp;where(const Expr &amp;where);</span><br><span class="line">    StatementSelect &amp;limit(const Expr &amp;limit);</span><br><span class="line">    StatementSelect &amp;having(const Expr &amp;having);</span><br><span class="line">    //...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class Expr : public Describable &#123;</span><br><span class="line">public:</span><br><span class="line">    Expr(const Column &amp;column);</span><br><span class="line">    template &lt;typename T&gt;</span><br><span class="line">    Expr(const T &amp;value,</span><br><span class="line">         typename std::enable_if&lt;std::is_arithmetic&lt;T&gt;::value ||</span><br><span class="line">                                 std::is_enum&lt;T&gt;::value&gt;::type * = nullptr)</span><br><span class="line">        : Describable(literalValue(value))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Expr(const std::string &amp;value);</span><br><span class="line"></span><br><span class="line">    Expr operator||(const Expr &amp;operand) const;</span><br><span class="line">    Expr operator&amp;&amp;(const Expr &amp;operand) const;</span><br><span class="line">    Expr operator!=(const Expr &amp;operand) const;</span><br><span class="line"></span><br><span class="line">    Expr between(const Expr &amp;left, const Expr &amp;right) const;</span><br><span class="line">    Expr notBetween(const Expr &amp;left, const Expr &amp;right) const;</span><br><span class="line"></span><br><span class="line">    Expr isNull() const;</span><br><span class="line">    Expr isNotNull() const;</span><br><span class="line">    </span><br><span class="line">    //...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>基于这个抽象方式，就可以对复杂查询中的条件语句进行重写为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Column content(&quot;content&quot;);</span><br><span class="line">Column createTime(&quot;createTime&quot;);</span><br><span class="line">Column modifiedTime(&quot;modifiedTime&quot;);</span><br><span class="line">Column type(&quot;type&quot;);</span><br><span class="line">StatementSelect select;</span><br><span class="line">//...</span><br><span class="line">//WHERE content IS NOT NULL </span><br><span class="line">//      AND createTime!=modifiedTime </span><br><span class="line">//      OR type NOT BETWEEN 0 AND 2</span><br><span class="line">select.where(Expr(content).isNotNull()</span><br><span class="line">            &amp;&amp;Expr(createTime)!=Expr(modifiedTime)</span><br><span class="line">            ||Expr(type).notBetween(0, 2));</span><br><span class="line">//...</span><br></pre></td></tr></table></figure></p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="建库"><a href="#建库" class="headerlink" title="建库"></a>建库</h3><p>WCTDatabase表示一个数据库，可以进行所有数据库操作，包括增删查改、表操作、事务、文件操作、损坏修复等。对于同一个路径的数据库，不同的WCTDatabase、WCTTable、WCTTransaction对象共享同一个WCDB核心。因此，你可以在代码的不同位置、不同线程任意创建不同的基础类对象，WCDB会自动管理它们的共享数据和线程并发。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSString *path = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,</span><br><span class="line"> NSUserDomainMask, YES).firstObject stringByAppendingPathComponent:@&quot;test.db&quot;];</span><br><span class="line">_database = [[WCTDatabase alloc] initWithPath: path];</span><br><span class="line">[_database close:^&#123;</span><br><span class="line">	[_database removeFilesWithError:nil];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (![_database isTableExists:@&quot;student&quot;]) &#123;</span><br><span class="line">	[_database createTableAndIndexesOfName:@&quot;student&quot; withClass:Student.class];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h3><h4 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Student *student = [[Student alloc] init];</span><br><span class="line">student.studentID = studentID;</span><br><span class="line">student.name = name;</span><br><span class="line">[_database insertObject:student into:@&quot;student&quot;];</span><br></pre></td></tr></table></figure>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return [_database getOneObjectOfClass:Student.class </span><br><span class="line">fromTable:@&quot;student&quot; where:Student.studentID == studentID];</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是我通读了WCDB的iOS官方文档和API做的一些总结，其中有一些自己的理解，同时也概括了WCDB的核心理念和使用方法。另外还有一些关于数据库修复、事务、约束的操作，没有详细列举。可以直接访问其github里面的中英文教程讲的非常详细。另外截止到2016年12月微信全球共计8.89亿月活用户，而新兴的公众号平台拥有1000万个，WCDB作为支撑这么一个平台的移动端数据库，其安全性和稳定性应该还是值得信赖的。如果是纯OC的项目，如果觉得CoreData学习成本高，不容易掌握，不是很稳定的话，推荐可以使用WCDB，但是项目中所有用到WCDB依赖的类实现文件都必须改成<code>.mm</code>的形式。但如果是Swift或者OC/Swift混编项目，WCDB目前对Swift还不是很友好，希望WCDB团队后续能对Swift进行支持吧。</p>
</div><div class="tags"><a href="/tags/Database/">Database</a></div><div class="post-nav"><a href="/2017/08/09/RxSwift响应式编程学习与理解/" class="pre">RxSwift响应式编程学习与理解</a><a href="/2016/07/17/iOS自定义模态视图转场/" class="next">iOS自定义模态视图转场</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'Hale';
var disqus_identifier = '2017/07/17/WCDB学习与理解/';
var disqus_title = 'WCDB学习与理解';
var disqus_url = 'http://wuqiuhao.github.io/2017/07/17/WCDB学习与理解/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//Hale.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://wuqiuhao.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/GeneratorType/" style="font-size: 15px;">GeneratorType</a> <a href="/tags/SequenceType/" style="font-size: 15px;">SequenceType</a> <a href="/tags/RxSwift/" style="font-size: 15px;">RxSwift</a> <a href="/tags/Concurrency-Operations-GCD/" style="font-size: 15px;">Concurrency Operations GCD</a> <a href="/tags/UILabel/" style="font-size: 15px;">UILabel</a> <a href="/tags/自动打包/" style="font-size: 15px;">自动打包</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/AVPlayerViewController/" style="font-size: 15px;">AVPlayerViewController</a> <a href="/tags/Custom-Transition/" style="font-size: 15px;">Custom Transition</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/01/Concurrency Programing in Swift/">Concurrency Programing in Swift</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/09/RxSwift响应式编程学习与理解/">RxSwift响应式编程学习与理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/17/WCDB学习与理解/">WCDB学习与理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/17/iOS自定义模态视图转场/">iOS自定义模态视图转场</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/08/fastlane gym实现ipa自动打包脚本/">使用fastlane gym实现ipa自动打包脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/02/Swift中的生成器和序列/">Swift中的生成器和序列</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/05/iOS视频、音频播放/">iOS视频、音频播放</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/30/UILabel垂直方向布局调整——实现居上居下效果/">UILabel垂直方向布局调整——实现居上居下效果</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//Hale.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Hale's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.1.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.1.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.1.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.1.0"></script></div></body></html>